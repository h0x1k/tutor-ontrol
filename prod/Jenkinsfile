pipeline {
    agent any
    
    environment {
        DOCKER_REGISTRY = 'localhost:5000'
        BACKEND_IMAGE = "${DOCKER_REGISTRY}/backend-prod"
        NGINX_IMAGE = "${DOCKER_REGISTRY}/nginx-prod"
    }
    
    triggers {
        // Triggered by dev pipeline or GitHub push via webhook
        // Enable webhook in Jenkins job settings
        // Fallback: Poll every 10 minutes
        pollSCM('H/10 * * * *')
    }
    
    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }
        
        stage('Sync Dev to Prod') {
            steps {
                sh '''
                    # Copy updated files from dev to prod
                    cp -r dev/backend/* prod/backend/
                    
                    # Copy frontend files (create directory if it doesn't exist)
                    mkdir -p prod/nginx/frontend
                    cp -r dev/nginx/frontend/* prod/nginx/frontend/
                    
                    # Keep prod-specific nginx.conf (don't overwrite with dev version)
                    # The prod nginx.conf handles both frontend and backend
                    
                    # Keep prod docker-compose.yml (it has different config than dev)
                '''
            }
        }
        
        stage('Run Prod Tests') {
            steps {
                dir('prod') {
                    sh '''
                        docker compose run --rm backend python manage.py test --no-input
                    '''
                }
            }
            post {
                success {
                    echo 'Prod tests passed!'
                }
                failure {
                    error('Prod tests failed!')
                }
            }
        }
        
        stage('Build Prod Images') {
            steps {
                dir('prod') {
                    sh """
                        docker compose build
                    """
                }
            }
        }
        
        stage('Version and Push Prod Images') {
            steps { 
                script { 
                    def backendTag = "prod-build-${BUILD_NUMBER}"
                    def nginxTag = "prod-build-${BUILD_NUMBER}"
                    
                    sh """
                        docker tag tutor-ontrol-backend:latest ${BACKEND_IMAGE}:${backendTag}
                        docker tag tutor-ontrol-backend:latest ${BACKEND_IMAGE}:latest
                        docker tag tutor-ontrol-nginx:latest ${NGINX_IMAGE}:${nginxTag}
                        docker tag tutor-ontrol-nginx:latest ${NGINX_IMAGE}:latest
                        
                        docker push ${BACKEND_IMAGE}:${backendTag}
                        docker push ${BACKEND_IMAGE}:latest
                        docker push ${NGINX_IMAGE}:${nginxTag}
                        docker push ${NGINX_IMAGE}:latest
                    """
                    
                    echo "Production images published:"
                    echo "Backend: ${BACKEND_IMAGE}:${backendTag}"
                    echo "Nginx: ${NGINX_IMAGE}:${nginxTag}"
                }
            }
        }
        
        stage('Deploy to Production') {
            steps {
                dir('prod') {
                    sh """
                        docker compose down
                        docker compose up -d
                        docker compose ps
                    """
                }
            }
        }
        
        stage('Update Main Branch') {
            steps {
                sh '''
                    git config user.email "jenkins@ci.com"
                    git config user.name "Jenkins CI"
                    
                    # Commit prod updates to main branch
                    git checkout main
                    git add prod/
                    git commit -m "Auto-update prod from dev (Build ${BUILD_NUMBER})" || echo "No changes to commit"
                    git push origin main
                    
                    # Switch back to dev for next build
                    git checkout dev
                '''
            }
        }
    }
    
    post {
        always {
            echo 'Prod pipeline completed'
            sh 'docker system prune -f'
        }
        success {
            echo 'Production updated successfully from dev!'
        }
    }
}