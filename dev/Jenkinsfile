pipeline {
    agent any
    
    environment {
        DOCKER_REGISTRY = 'localhost:5000'
        FRONTEND_IMAGE = "${DOCKER_REGISTRY}/frontend-dev"
        BACKEND_IMAGE = "${DOCKER_REGISTRY}/backend-dev"
        VERSIONCONTROL_IMAGE = "${DOCKER_REGISTRY}/versioncontrol-dev"
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Build Frontend') {
            steps {
                dir('nginx/frontend') {
                    sh '''
                        docker build -f Dockerfile.frontend -t ${FRONTEND_IMAGE}:${BUILD_NUMBER} .
                        docker tag ${FRONTEND_IMAGE}:${BUILD_NUMBER} ${FRONTEND_IMAGE}:latest
                    '''
                }
            }
        }
        
        stage('Build Backend') {
            steps {
                dir('backend') {
                    sh '''
                        docker build -t ${BACKEND_IMAGE}:${BUILD_NUMBER} .
                        docker tag ${BACKEND_IMAGE}:${BUILD_NUMBER} ${BACKEND_IMAGE}:latest
                    '''
                }
            }
        }
        
        stage('Build Version Control') {
            steps {
                dir('../version_control') {
                    sh '''
                        docker build -t ${VERSIONCONTROL_IMAGE}:${BUILD_NUMBER} .
                        docker tag ${VERSIONCONTROL_IMAGE}:${BUILD_NUMBER} ${VERSIONCONTROL_IMAGE}:latest
                    '''
                }
            }
        }
        
        stage('Run Tests') {
            steps {
                dir('backend') {
                    sh '''
                        docker run --rm ${BACKEND_IMAGE}:latest python manage.py test --no-input || true
                    '''
                }
            }
        }
        
        stage('Deploy Dev') {
            steps {
                dir('.') {
                    sh '''
                        docker-compose down || true
                        docker-compose up -d
                        sleep 10
                        docker-compose ps
                    '''
                }
            }
        }
        
        stage('Health Check') {
            steps {
                sh '''
                    sleep 5
                    curl -f http://localhost/ || echo "Frontend health check failed"
                    curl -f http://localhost:8001/health || echo "Version control health check failed"
                '''
            }
        }
    }
    
    post {
        always {
            echo 'Dev pipeline completed'
            sh 'docker system prune -f'
        }
        success {
            echo '✅ Dev deployment successful!'
        }
        failure {
            echo '❌ Dev deployment failed!'
        }
    }
}

