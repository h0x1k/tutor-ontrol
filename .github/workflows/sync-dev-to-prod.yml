name: Sync Dev to Prod

on:
  push:
    branches:
      - main
    paths:
      - 'dev/**'
      - 'version_control/**'
      - 'tutor/**'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Sync Dev to Prod
        run: |
          echo "ðŸ”„ Syncing changes from dev/ to prod/..."
          
          # Copy backend files
          if [ -d "dev/backend" ]; then
            echo "ðŸ“¦ Copying backend files..."
            rm -rf prod/backend
            cp -r dev/backend prod/backend
          fi
          
          # Copy frontend files
          if [ -d "dev/frontend" ]; then
            echo "ðŸ“¦ Copying frontend files..."
            rm -rf prod/frontend
            cp -r dev/frontend prod/frontend
          fi
          
          # Copy nginx configuration
          if [ -d "dev/nginx" ]; then
            echo "ðŸ“¦ Copying nginx configuration..."
            rm -rf prod/nginx
            cp -r dev/nginx prod/nginx
          fi
          
          # Copy version control (if changed)
          if [ -d "version_control" ]; then
            echo "ðŸ“¦ Version control already in root, keeping it..."
          fi
          
          # Copy Dockerfiles
          if [ -f "dev/Dockerfile.backend" ]; then
            cp dev/Dockerfile.backend prod/Dockerfile.backend
          fi
          
          if [ -f "dev/Dockerfile.nginx" ]; then
            cp dev/Dockerfile.nginx prod/Dockerfile.nginx
          fi
          
          # Copy Jenkinsfile (optional - you may want to keep prod-specific)
          # cp dev/Jenkinsfile prod/Jenkinsfile
          
          echo "âœ… Sync completed!"

      - name: Check for Changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain prod/)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changes detected in prod/"
            git status
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "âœ… No changes to sync"
          fi

      - name: Commit and Push Changes
        if: steps.check-changes.outputs.changes == 'true'
        run: |
          git add prod/
          git commit -m "ðŸ”„ Auto-sync from dev to prod (Build ${{ github.run_number }})" || exit 0
          git push origin main || echo "Push skipped (may need manual push)"

      - name: Summary
        run: |
          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Source:** dev/" >> $GITHUB_STEP_SUMMARY
          echo "- **Destination:** prod/" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-changes.outputs.changes }}" == "true" ]; then
            echo "- **Status:** âœ… Changes synced and committed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** â„¹ï¸ No changes to sync" >> $GITHUB_STEP_SUMMARY
          fi

