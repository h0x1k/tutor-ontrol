name: Production Deployment

on:
  push:
    branches:
      - dev
    paths:
      - 'dev/**'
      - 'version_control/**'
  workflow_dispatch:  # Allow manual trigger

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Sync Dev to Prod
        run: |
          echo "ðŸ”„ Syncing files from dev to prod..."
          
          # Copy backend files
          if [ -d "dev/backend" ]; then
            mkdir -p prod/backend
            cp -r dev/backend/* prod/backend/ 2>/dev/null || true
          fi
          
          # Copy frontend files
          if [ -d "dev/nginx/frontend" ]; then
            mkdir -p prod/nginx/frontend
            cp -r dev/nginx/frontend/* prod/nginx/frontend/ 2>/dev/null || true
          fi
          
          # Copy version control
          if [ -d "version_control" ]; then
            mkdir -p prod/version_control
            cp -r version_control/* prod/version_control/ 2>/dev/null || true
          fi
          
          echo "âœ… Sync completed"
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Verify Sync Results
        run: |
          echo "ðŸ“‹ Synced files:"
          ls -la prod/backend/ 2>/dev/null | head -5 || echo "Backend directory not found"
          ls -la prod/nginx/frontend/ 2>/dev/null | head -5 || echo "Frontend directory not found"
          echo "âœ… Sync verification completed"
      
      - name: Run Production Tests (if backend exists)
        working-directory: ./prod/backend
        continue-on-error: true
        run: |
          if [ -f "Dockerfile" ]; then
            docker build -t backend-prod-test:${{ github.sha }} .
            docker run --rm backend-prod-test:${{ github.sha }} python manage.py test --no-input || echo "Tests completed with warnings"
          else
            echo "âš ï¸ Production backend not found, skipping tests..."
          fi
      
      - name: Build Production Images (if docker-compose exists)
        working-directory: ./prod
        continue-on-error: true
        run: |
          if [ -f "docker-compose.yml" ]; then
            echo "ðŸ³ Building production images..."
            docker-compose build || echo "Build completed with warnings"
          else
            echo "âš ï¸ Production docker-compose.yml not found, skipping build..."
          fi
      
      - name: Summary
        run: |
          echo "âœ… Production sync completed"
          echo "ðŸ“ Note: Actual deployment requires:"
          echo "   1. Production server with Docker"
          echo "   2. Manual deployment or Jenkins pipeline"
          echo "   3. Or use this workflow to prepare artifacts"
      
      - name: Commit Prod Updates (Optional)
        if: github.ref == 'refs/heads/dev'
        continue-on-error: true
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          if [ -n "$(git status --porcelain prod/)" ]; then
            git checkout main 2>/dev/null || git checkout -b main
            git add prod/
            git commit -m "Auto-update prod from dev (Build ${{ github.sha }})" || exit 0
            git push origin main || echo "Push to main skipped (may need token)"
            git checkout dev || echo "Could not switch back to dev"
          else
            echo "No changes to commit in prod/"
          fi

